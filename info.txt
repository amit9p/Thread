with definitions_choices as (
  select * from EDA_CDO_SURVEY_DEV.CDOSURVEY_T.stg_surv_ques_cho
),
import_choices as (
  select * from EDA_CDO_SURVEY_DEV.CDO_SURVEY_T.stg_impt_id_map
  qualify row_number() over (partition by surv_id , ques_id , cho_id order by load_dt desc) = 1
),
cho_syskey_subquery as (
  select DISTINCT SURV_ID, QUES_ID, CHO_SYSKEY
  from definitions_choices
)

select 
  COALESCE(sub.CHO_SYSKEY, '-1') as CHO_SYSKEY,
  I.QUES_SYS_KEY,
  I.SURV_ID,
  COALESCE(I.CHO_ID , D.CHO_ID) AS CHO_ID,
  COALESCE(I.CHO_DSPL_TXT, D.CHO_TXT) AS CHO_DSPL_TXT
FROM import_choices I

LEFT JOIN definitions_choices D
using (SURV_ID , QUES_ID, CHO_ID)

LEFT JOIN cho_syskey_subquery sub
using (SURV_ID, QUES_ID)
