LIST @EDA_CDO_SURVEY_DEV.CDO_SURVEY_LOAD.QLTRCS_SURVEY_RSTMT_STG/definitions/questionmapping/2023/11/02;

COPY INTO EDA_CDO_SURVEY_DEV.CDO_SURVEY_T.QLTRCS_SCHM_QUESMAP 
FROM @EDA_CDO_SURVEY_DEV.CDO_SURVEY_LOAD.QLTRCS_SURVEY_RSTMT_STG/definitions/questionmapping/2023/11/02 
FILE_FORMAT => (FORMAT_NAME = EDA_CDO_SURVEY_DEV.CDO_SURVEY_LOAD.CSV_FMT) 
FORCE = TRUE;


CREATE OR REPLACE TASK EDA_CDO_SURVEY_DEV.CDO_SURVEY_LOAD.APRASA10_QLTRCS_SURV_QUESMAP_LOAD_PRC_TSK
WAREHOUSE=EDA_CDO_SURVEY_XSMALL_WH
SCHEDULE='USING CRON */5 * * * * America/New_York'
ERROR_INTEGRATION = EDA_CDO_SURVEY_NTFY_INTGR
AS CALL EDA_CDO_SURVEY_DEV.CDO_SURVEY_LOAD.APRASA10_QLTRCS_SURV_QUESMAP_LOAD_PRC('incremental', '');

SCHEDULE = 'USING CRON 0 15 10 12 JAN ? 2025 America/Los_Angeles'


Feature: Snowflake Stored Procedure Error Handling with AWS SNS Email Notification

  Scenario Outline: Stored procedure throws an error which triggers an AWS SNS email notification
    Given the stored procedure "<StoredProcName>" is set to trigger an AWS SNS email on failure
    And a task "<TaskName>" is scheduled to execute the stored procedure
    When the task is triggered
    Then the stored procedure should attempt to execute its operations
    But if the stored procedure fails
    Then an error message "<ErrorMessage>" should be logged
    And an AWS SNS email notification should be sent to the specified recipients


WHEN (
  SURV_ID = 'SV_es2GPhwuAlrknhI' AND (
    COALESCE(RSPN_JSON:result:values:Disqualified, RSPN_JSON:values:Disqualified) <> 'Y' OR
    (
      COALESCE(RSPN_JSON:result:values:QID7, '') = '' OR
      COALESCE(RSPN_JSON:result:values:QID30, '') = ''
    )
  )
) THEN 1



WHEN (SURV_ID = 'SV_es2GPhwuAlrknhI' AND (
      COALESCE(RSPN_JSON:result:values:Disqualified, RSPN_JSON:values:Disqualified) <> 'Y' AND
     (COALESCE(RSPN_JSON:result:values:QID7, RSPN_JSON:values:QID7)  IS NULL OR
      COALESCE(RSPN_JSON:result:values:QID7, RSPN_JSON:values:QID7)  = '') AND
     (COALESCE(RSPN_JSON:result:values:QID30, RSPN_JSON:values:QID30) IS NULL OR
      COALESCE(RSPN_JSON:result:values:QID30, RSPN_JSON:values:QID30) = ''))) THEN 1


WHEN (SURV_ID = 'SV_2rd9TwFmJsoEZWC' AND (
    (TRY_TO_TIMESTAMP(COALESCE(RSPN_JSON:result:values:endDate::string, RSPN_JSON:values:EndDate::string)) < '2023-10-18'::date OR
     COALESCE(RSPN_JSON:result:values:endDate, RSPN_JSON:values:EndDate) IS NULL)
)) THEN 1



Feature: Exclude survey results prior to 9/7/2022 for survey SV_2rd9TwFmJsoEZWC

  In order to maintain accurate data in the Qualtrics dashboard
  As a data analyst
  I want to ensure that no survey results before 9/7/2022 are included in the query for survey SV_2rd9TwFmJsoEZWC

  Scenario Outline: Query survey results after a specific date
    Given the survey "<survey_id>" has been conducted
    And the survey end date threshold is set to "<threshold_date>"
    When I query for survey responses
    Then I should not get any results that occurred before the "<threshold_date>"

    Examples:
      | survey_id           | threshold_date |
      | SV_2rd9TwFmJsoEZWC  | 2022-09-07     |

